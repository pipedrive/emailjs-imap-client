"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parserHelper = void 0;
var _common = require("./common");
var _emailjsImapHandler = require("emailjs-imap-handler");
const isUnexpectedCharError = e => e && e.message && e.message.toLowerCase().indexOf('unexpected char at position') !== -1;

// according to the https://www.rfc-editor.org/rfc/rfc2047
const encodedWordsRegex = /=\?[^?]+\?[^?]+\?(.+?)\?=/ig;
const serverBugRegex = /(.+NO\s+\[SERVERBUG])(.+)/i;
const commandNotAllowedStringCharacter = /[^a-zA-Z-.0-9_: ]/ig;
const sanitizeEncodedWords = command => {
  const allMatches = command.matchAll(encodedWordsRegex);
  let changedCommand = command;
  for (const match of allMatches) {
    if (match.length !== 2) {
      continue;
    }
    if (match[1].indexOf('"') === -1) {
      continue;
    }
    const repl = match[1].replaceAll(/"/ig, '');
    changedCommand = changedCommand.replace(match[1], repl);
  }
  return changedCommand;
};
const sanitizeServerBug = command => {
  const foundMatch = serverBugRegex.exec(command);
  if (foundMatch.length !== 3) {
    return command;
  }
  return [foundMatch[1], foundMatch[2].replaceAll(commandNotAllowedStringCharacter, '').trim()].join(' ');
};
const parsingHacks = [{
  // parsing hack in situation when last character breaks parsing
  func: (command, opts) => (0, _emailjsImapHandler.parser)(command.slice(0, -1), opts),
  condition: (command, e) => e && e.message === `Unexpected char at position ${command.length - 1}` && typeof command.slice === 'function'
}, {
  // parsing hack which is caused by provider returning command with two sequential double quotes ""
  func: (command, opts) => (0, _emailjsImapHandler.parser)((0, _common.toTypedArray)((0, _common.fromTypedArray)(command).replaceAll(/""/ig, '"')), opts),
  condition: (command, e) => isUnexpectedCharError(e)
}, {
  // parsing hack which is caused by provider returning command with encoded-words with quotes in ATOM instructions
  func: (command, opts) => (0, _emailjsImapHandler.parser)((0, _common.toTypedArray)(sanitizeEncodedWords((0, _common.fromTypedArray)(command))), opts),
  condition: (command, e) => isUnexpectedCharError(e) && (0, _common.fromTypedArray)(command).search(encodedWordsRegex) !== -1
}, {
  // parsing hack which is caused by provider returning NO [SERVERBUG] unparseable message
  func: (command, opts) => (0, _emailjsImapHandler.parser)((0, _common.toTypedArray)(sanitizeServerBug((0, _common.fromTypedArray)(command))), opts),
  condition: (command, e) => isUnexpectedCharError(e) && (0, _common.fromTypedArray)(command).search(serverBugRegex) !== -1
}];
const parserHelper = (command, opts) => {
  try {
    return (0, _emailjsImapHandler.parser)(command, opts);
  } catch (e) {
    for (let i = 0; i < parsingHacks.length; i++) {
      const attempt = parsingHacks[i];
      if (!attempt.condition(command, e)) {
        continue;
      }
      try {
        return attempt.func(command, opts);
      } catch (e) {}
    }
    throw e;
  }
};
exports.parserHelper = parserHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfY29tbW9uIiwicmVxdWlyZSIsIl9lbWFpbGpzSW1hcEhhbmRsZXIiLCJpc1VuZXhwZWN0ZWRDaGFyRXJyb3IiLCJlIiwibWVzc2FnZSIsInRvTG93ZXJDYXNlIiwiaW5kZXhPZiIsImVuY29kZWRXb3Jkc1JlZ2V4Iiwic2VydmVyQnVnUmVnZXgiLCJjb21tYW5kTm90QWxsb3dlZFN0cmluZ0NoYXJhY3RlciIsInNhbml0aXplRW5jb2RlZFdvcmRzIiwiY29tbWFuZCIsImFsbE1hdGNoZXMiLCJtYXRjaEFsbCIsImNoYW5nZWRDb21tYW5kIiwibWF0Y2giLCJsZW5ndGgiLCJyZXBsIiwicmVwbGFjZUFsbCIsInJlcGxhY2UiLCJzYW5pdGl6ZVNlcnZlckJ1ZyIsImZvdW5kTWF0Y2giLCJleGVjIiwidHJpbSIsImpvaW4iLCJwYXJzaW5nSGFja3MiLCJmdW5jIiwib3B0cyIsInBhcnNlciIsInNsaWNlIiwiY29uZGl0aW9uIiwidG9UeXBlZEFycmF5IiwiZnJvbVR5cGVkQXJyYXkiLCJzZWFyY2giLCJwYXJzZXJIZWxwZXIiLCJpIiwiYXR0ZW1wdCIsImV4cG9ydHMiXSwic291cmNlcyI6WyIuLi9zcmMvcGFyc2VyLWhlbHBlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0b1R5cGVkQXJyYXksIGZyb21UeXBlZEFycmF5IH0gZnJvbSAnLi9jb21tb24nXG5pbXBvcnQgeyBwYXJzZXIgfSBmcm9tICdlbWFpbGpzLWltYXAtaGFuZGxlcidcblxuY29uc3QgaXNVbmV4cGVjdGVkQ2hhckVycm9yID0gZSA9PiBlICYmIGUubWVzc2FnZSAmJiBlLm1lc3NhZ2UudG9Mb3dlckNhc2UoKVxuICAuaW5kZXhPZigndW5leHBlY3RlZCBjaGFyIGF0IHBvc2l0aW9uJykgIT09IC0xXG5cbi8vIGFjY29yZGluZyB0byB0aGUgaHR0cHM6Ly93d3cucmZjLWVkaXRvci5vcmcvcmZjL3JmYzIwNDdcbmNvbnN0IGVuY29kZWRXb3Jkc1JlZ2V4ID0gLz1cXD9bXj9dK1xcP1teP10rXFw/KC4rPylcXD89L2lnXG5jb25zdCBzZXJ2ZXJCdWdSZWdleCA9IC8oLitOT1xccytcXFtTRVJWRVJCVUddKSguKykvaVxuY29uc3QgY29tbWFuZE5vdEFsbG93ZWRTdHJpbmdDaGFyYWN0ZXIgPSAvW15hLXpBLVotLjAtOV86IF0vaWdcblxuY29uc3Qgc2FuaXRpemVFbmNvZGVkV29yZHMgPSBjb21tYW5kID0+IHtcbiAgY29uc3QgYWxsTWF0Y2hlcyA9IGNvbW1hbmQubWF0Y2hBbGwoZW5jb2RlZFdvcmRzUmVnZXgpXG5cbiAgbGV0IGNoYW5nZWRDb21tYW5kID0gY29tbWFuZFxuXG4gIGZvciAoY29uc3QgbWF0Y2ggb2YgYWxsTWF0Y2hlcykge1xuICAgIGlmIChtYXRjaC5sZW5ndGggIT09IDIpIHtcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgaWYgKG1hdGNoWzFdLmluZGV4T2YoJ1wiJykgPT09IC0xKSB7XG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGNvbnN0IHJlcGwgPSBtYXRjaFsxXS5yZXBsYWNlQWxsKC9cIi9pZywgJycpXG5cbiAgICBjaGFuZ2VkQ29tbWFuZCA9IGNoYW5nZWRDb21tYW5kLnJlcGxhY2UobWF0Y2hbMV0sIHJlcGwpXG4gIH1cblxuICByZXR1cm4gY2hhbmdlZENvbW1hbmRcbn1cblxuY29uc3Qgc2FuaXRpemVTZXJ2ZXJCdWcgPSBjb21tYW5kID0+IHtcbiAgY29uc3QgZm91bmRNYXRjaCA9IHNlcnZlckJ1Z1JlZ2V4LmV4ZWMoY29tbWFuZClcblxuICBpZiAoZm91bmRNYXRjaC5sZW5ndGggIT09IDMpIHtcbiAgICByZXR1cm4gY29tbWFuZFxuICB9XG5cbiAgcmV0dXJuIFtcbiAgICBmb3VuZE1hdGNoWzFdLFxuICAgIGZvdW5kTWF0Y2hbMl0ucmVwbGFjZUFsbChjb21tYW5kTm90QWxsb3dlZFN0cmluZ0NoYXJhY3RlciwgJycpLnRyaW0oKVxuICBdLmpvaW4oJyAnKVxufVxuXG5jb25zdCBwYXJzaW5nSGFja3MgPSBbXG4gIHtcbiAgICAvLyBwYXJzaW5nIGhhY2sgaW4gc2l0dWF0aW9uIHdoZW4gbGFzdCBjaGFyYWN0ZXIgYnJlYWtzIHBhcnNpbmdcbiAgICBmdW5jOiAoY29tbWFuZCwgb3B0cykgPT4gcGFyc2VyKGNvbW1hbmQuc2xpY2UoMCwgLTEpLCBvcHRzKSxcbiAgICBjb25kaXRpb246IChjb21tYW5kLCBlKSA9PiBlICYmIGUubWVzc2FnZSA9PT0gYFVuZXhwZWN0ZWQgY2hhciBhdCBwb3NpdGlvbiAke2NvbW1hbmQubGVuZ3RoIC0gMX1gICYmIHR5cGVvZiBjb21tYW5kLnNsaWNlID09PSAnZnVuY3Rpb24nXG4gIH0sXG4gIHtcbiAgICAvLyBwYXJzaW5nIGhhY2sgd2hpY2ggaXMgY2F1c2VkIGJ5IHByb3ZpZGVyIHJldHVybmluZyBjb21tYW5kIHdpdGggdHdvIHNlcXVlbnRpYWwgZG91YmxlIHF1b3RlcyBcIlwiXG4gICAgZnVuYzogKGNvbW1hbmQsIG9wdHMpID0+IHBhcnNlcih0b1R5cGVkQXJyYXkoZnJvbVR5cGVkQXJyYXkoY29tbWFuZCkucmVwbGFjZUFsbCgvXCJcIi9pZywgJ1wiJykpLCBvcHRzKSxcbiAgICBjb25kaXRpb246IChjb21tYW5kLCBlKSA9PiBpc1VuZXhwZWN0ZWRDaGFyRXJyb3IoZSlcbiAgfSxcbiAge1xuICAgIC8vIHBhcnNpbmcgaGFjayB3aGljaCBpcyBjYXVzZWQgYnkgcHJvdmlkZXIgcmV0dXJuaW5nIGNvbW1hbmQgd2l0aCBlbmNvZGVkLXdvcmRzIHdpdGggcXVvdGVzIGluIEFUT00gaW5zdHJ1Y3Rpb25zXG4gICAgZnVuYzogKGNvbW1hbmQsIG9wdHMpID0+IHBhcnNlcih0b1R5cGVkQXJyYXkoc2FuaXRpemVFbmNvZGVkV29yZHMoZnJvbVR5cGVkQXJyYXkoY29tbWFuZCkpKSwgb3B0cyksXG4gICAgY29uZGl0aW9uOiAoY29tbWFuZCwgZSkgPT4gaXNVbmV4cGVjdGVkQ2hhckVycm9yKGUpICYmIGZyb21UeXBlZEFycmF5KGNvbW1hbmQpLnNlYXJjaChlbmNvZGVkV29yZHNSZWdleCkgIT09IC0xXG4gIH0sXG4gIHtcbiAgICAvLyBwYXJzaW5nIGhhY2sgd2hpY2ggaXMgY2F1c2VkIGJ5IHByb3ZpZGVyIHJldHVybmluZyBOTyBbU0VSVkVSQlVHXSB1bnBhcnNlYWJsZSBtZXNzYWdlXG4gICAgZnVuYzogKGNvbW1hbmQsIG9wdHMpID0+IHBhcnNlcih0b1R5cGVkQXJyYXkoc2FuaXRpemVTZXJ2ZXJCdWcoZnJvbVR5cGVkQXJyYXkoY29tbWFuZCkpKSwgb3B0cyksXG4gICAgY29uZGl0aW9uOiAoY29tbWFuZCwgZSkgPT4gaXNVbmV4cGVjdGVkQ2hhckVycm9yKGUpICYmIGZyb21UeXBlZEFycmF5KGNvbW1hbmQpLnNlYXJjaChzZXJ2ZXJCdWdSZWdleCkgIT09IC0xXG4gIH1cbl1cblxuZXhwb3J0IGNvbnN0IHBhcnNlckhlbHBlciA9IChjb21tYW5kLCBvcHRzKSA9PiB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIHBhcnNlcihjb21tYW5kLCBvcHRzKVxuICB9IGNhdGNoIChlKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJzaW5nSGFja3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGF0dGVtcHQgPSBwYXJzaW5nSGFja3NbaV1cblxuICAgICAgaWYgKCFhdHRlbXB0LmNvbmRpdGlvbihjb21tYW5kLCBlKSkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gYXR0ZW1wdC5mdW5jKGNvbW1hbmQsIG9wdHMpXG4gICAgICB9IGNhdGNoIChlKSB7IH1cbiAgICB9XG5cbiAgICB0aHJvdyBlXG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsT0FBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsbUJBQUEsR0FBQUQsT0FBQTtBQUVBLE1BQU1FLHFCQUFxQixHQUFHQyxDQUFDLElBQUlBLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxPQUFPLElBQUlELENBQUMsQ0FBQ0MsT0FBTyxDQUFD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